<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="CleanUninstaller.Views.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:CleanUninstaller.Models"
    xmlns:local="using:CleanUninstaller.Views"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:ctControls="using:CommunityToolkit.WinUI.Controls"
    Title="Clean Uninstaller">

    <Window.SystemBackdrop>
        <MicaBackdrop />
    </Window.SystemBackdrop>

    <Grid>
        <Grid.ChildrenTransitions>
            <TransitionCollection>
                <EntranceThemeTransition />
            </TransitionCollection>
        </Grid.ChildrenTransitions>
        
        <Grid.RowDefinitions>
            <RowDefinition Height="48" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Title Bar -->
        <Grid x:Name="AppTitleBar" Grid.Row="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            
            <StackPanel Orientation="Horizontal" Spacing="12" Margin="16,0">
                <FontIcon Glyph="&#xE74D;" FontSize="18" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                <TextBlock Text="Clean Uninstaller" 
                           Style="{StaticResource CaptionTextBlockStyle}"
                           VerticalAlignment="Center" />
                <InfoBadge Value="1" Style="{StaticResource AttentionValueInfoBadgeStyle}" 
                           VerticalAlignment="Center" Visibility="Collapsed" />
            </StackPanel>
        </Grid>

        <!-- CommandBar Toolbar -->
        <CommandBar Grid.Row="1" 
                    DefaultLabelPosition="Right"
                    Background="{ThemeResource LayerFillColorDefaultBrush}"
                    IsOpen="False">
            <CommandBar.Content>
                <AutoSuggestBox x:Name="SearchBox"
                                PlaceholderText="Rechercher un programme..."
                                QueryIcon="Find"
                                TextChanged="SearchBox_TextChanged"
                                Width="300"
                                Margin="12,0" />
            </CommandBar.Content>
            
            <AppBarButton x:Name="RefreshButton"
                          Icon="Refresh"
                          Label="Actualiser"
                          Click="RefreshButton_Click"
                          ToolTipService.ToolTip="Actualiser la liste (F5)"
                          AccessKey="F5" />

            <AppBarButton x:Name="UninstallButton"
                          Label="Désinstaller"
                          Click="UninstallButton_Click"
                          ToolTipService.ToolTip="Désinstaller le programme sélectionné">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE74D;" />
                </AppBarButton.Icon>
                <AppBarButton.Flyout>
                    <MenuFlyout Placement="Bottom">
                        <MenuFlyoutItem Text="Désinstallation standard" Icon="Delete" Click="UninstallStandard_Click" />
                        <MenuFlyoutItem Text="Désinstallation silencieuse" Click="UninstallSilent_Click">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE74F;" />
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                        <MenuFlyoutSeparator />
                        <MenuFlyoutItem Text="Désinstallation forcée" Click="UninstallForced_Click"
                                        Foreground="{ThemeResource SystemFillColorCriticalBrush}">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE7BA;" Foreground="{ThemeResource SystemFillColorCriticalBrush}" />
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                        <MenuFlyoutSeparator />
                        <MenuFlyoutItem Text="Désinstaller la sélection" Click="UninstallBatch_Click">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE762;" />
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                    </MenuFlyout>
                </AppBarButton.Flyout>
            </AppBarButton>

            <AppBarSeparator />

            <AppBarButton x:Name="ExportButton" 
                          Icon="Save"
                          Label="Exporter"
                          Click="ExportButton_Click"
                          ToolTipService.ToolTip="Exporter la liste des programmes" />

            <AppBarSeparator />

            <AppBarButton Icon="Sort" Label="Trier">
                <AppBarButton.Flyout>
                    <MenuFlyout>
                        <RadioMenuFlyoutItem x:Name="SortByNameItem" Text="Nom" IsChecked="True" Click="SortByName_Click" />
                        <RadioMenuFlyoutItem x:Name="SortByPublisherItem" Text="Éditeur" Click="SortByPublisher_Click" />
                        <RadioMenuFlyoutItem x:Name="SortBySizeItem" Text="Taille" Click="SortBySize_Click" />
                        <RadioMenuFlyoutItem x:Name="SortByDateItem" Text="Date d'installation" Click="SortByDate_Click" />
                        <MenuFlyoutSeparator />
                        <ToggleMenuFlyoutItem x:Name="SortDescendingItem" Text="Ordre décroissant" Click="SortOrder_Click" />
                    </MenuFlyout>
                </AppBarButton.Flyout>
            </AppBarButton>

            <AppBarButton Label="Filtres">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE71C;" />
                </AppBarButton.Icon>
                <AppBarButton.Flyout>
                    <MenuFlyout>
                        <ToggleMenuFlyoutItem x:Name="ShowSystemAppsToggle" 
                                              Text="Applications système"
                                              Click="FilterChanged_Click" />
                        <ToggleMenuFlyoutItem x:Name="ShowWindowsAppsToggle" 
                                              Text="Applications Windows Store"
                                              IsChecked="True"
                                              Click="FilterChanged_Click" />
                        <MenuFlyoutSeparator />
                        <MenuFlyoutSubItem Text="Filtrer par taille">
                            <RadioMenuFlyoutItem x:Name="SizeFilterAllItem" 
                                                 Text="Toutes les tailles" 
                                                 IsChecked="True"
                                                 Click="SizeFilter_Click" Tag="All" />
                            <MenuFlyoutSeparator />
                            <RadioMenuFlyoutItem x:Name="SizeFilterSmallItem" 
                                                 Text="Petit (&lt; 10 Mo)" 
                                                 Click="SizeFilter_Click" Tag="Small" />
                            <RadioMenuFlyoutItem x:Name="SizeFilterMediumItem" 
                                                 Text="Moyen (10 - 100 Mo)" 
                                                 Click="SizeFilter_Click" Tag="Medium" />
                            <RadioMenuFlyoutItem x:Name="SizeFilterLargeItem" 
                                                 Text="Grand (100 Mo - 1 Go)" 
                                                 Click="SizeFilter_Click" Tag="Large" />
                            <RadioMenuFlyoutItem x:Name="SizeFilterVeryLargeItem" 
                                                 Text="Très grand (&gt; 1 Go)" 
                                                 Click="SizeFilter_Click" Tag="VeryLarge" />
                            <MenuFlyoutSeparator />
                            <RadioMenuFlyoutItem x:Name="SizeFilterUnknownItem" 
                                                 Text="Taille inconnue" 
                                                 Click="SizeFilter_Click" Tag="Unknown" />
                        </MenuFlyoutSubItem>
                        <MenuFlyoutSeparator />
                        <MenuFlyoutItem Text="Réinitialiser les filtres" Click="ResetFilters_Click">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE72C;" />
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                    </MenuFlyout>
                </AppBarButton.Flyout>
            </AppBarButton>

            <AppBarSeparator />

            <AppBarButton Label="Outils">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE90F;" />
                </AppBarButton.Icon>
                <AppBarButton.Flyout>
                    <MenuFlyout>
                        <MenuFlyoutItem Text="Programmes orphelins" 
                                        Click="OrphanedPrograms_Click"
                                        ToolTipService.ToolTip="Détecter et supprimer les entrées de registre orphelines">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE7BA;" />
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                    </MenuFlyout>
                </AppBarButton.Flyout>
            </AppBarButton>

            <CommandBar.SecondaryCommands>
                <AppBarButton x:Name="SettingsButton" 
                              Icon="Setting"
                              Label="Paramètres"
                              Click="SettingsButton_Click" />
            </CommandBar.SecondaryCommands>
        </CommandBar>

        <!-- Main Content -->
        <Grid Grid.Row="2">
            <Grid.ChildrenTransitions>
                <TransitionCollection>
                    <ContentThemeTransition />
                </TransitionCollection>
            </Grid.ChildrenTransitions>
            
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="ProgramListColumn" Width="*" MinWidth="450" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition x:Name="DetailsPanelColumn" Width="380" MinWidth="280" MaxWidth="600" />
            </Grid.ColumnDefinitions>

            <!-- Program List -->
            <Grid Padding="16">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- InfoBar pour les messages -->
                <InfoBar x:Name="MainInfoBar" 
                         IsOpen="False" 
                         Severity="Informational"
                         Margin="0,0,0,8">
                    <InfoBar.Transitions>
                        <TransitionCollection>
                            <AddDeleteThemeTransition />
                        </TransitionCollection>
                    </InfoBar.Transitions>
                </InfoBar>

                <Grid Grid.Row="1" Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <CheckBox x:Name="SelectAllCheckbox" 
                              Content="Tout sélectionner"
                              Click="SelectAllCheckbox_Click" />

                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="16">
                        <TextBlock x:Name="SelectionInfoText"
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                   VerticalAlignment="Center"
                                   Visibility="Collapsed" />
                        <TextBlock x:Name="ProgramCountText"
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   VerticalAlignment="Center"
                                   Text="0 programmes" />
                    </StackPanel>
                </Grid>

                <!-- En-tête de colonnes -->
                <Grid x:Name="HeaderGrid" Grid.Row="2" Margin="8,0,8,4" Padding="8,6">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="32" />          <!-- Checkbox -->
                        <ColumnDefinition Width="40" />          <!-- Icône -->
                        <ColumnDefinition x:Name="NameColumn" Width="*" MinWidth="80" />
                        <ColumnDefinition Width="3" />           <!-- Splitter -->
                        <ColumnDefinition x:Name="PublisherColumn" Width="100" MinWidth="40" />
                        <ColumnDefinition Width="3" />           <!-- Splitter -->
                        <ColumnDefinition x:Name="DateColumn" Width="75" MinWidth="40" />
                        <ColumnDefinition Width="3" />           <!-- Splitter -->
                        <ColumnDefinition x:Name="SizeColumn" Width="60" MinWidth="40" />
                    </Grid.ColumnDefinitions>
                    
                    <!-- Nom -->
                    <Button Grid.Column="2" 
                            Style="{StaticResource SubtleButtonStyle}"
                            HorizontalAlignment="Left"
                            Padding="4,2"
                            Click="SortByNameHeader_Click"
                            ToolTipService.ToolTip="Trier par nom">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="Nom" 
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                            <FontIcon x:Name="SortNameIcon" 
                                      Glyph="&#xE70D;" 
                                      FontSize="10" 
                                      Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                      Visibility="Visible" />
                        </StackPanel>
                    </Button>
                    
                    <!-- Splitter Nom/Éditeur -->
                    <controls:GridSplitter Grid.Column="3" 
                                           Width="3"
                                           ResizeBehavior="BasedOnAlignment"
                                           ResizeDirection="Columns"
                                           Background="{ThemeResource DividerStrokeColorDefaultBrush}"
                                           PointerPressed="GridSplitter_PointerPressed"
                                           PointerReleased="GridSplitter_PointerReleased"
                                           PointerCaptureLost="GridSplitter_PointerReleased" />
                    
                    <!-- Éditeur -->
                    <Button Grid.Column="4" 
                            Style="{StaticResource SubtleButtonStyle}"
                            HorizontalAlignment="Left"
                            Padding="4,2"
                            Click="SortByPublisherHeader_Click"
                            ToolTipService.ToolTip="Trier par éditeur">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="Éditeur" 
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                            <FontIcon x:Name="SortPublisherIcon" 
                                      Glyph="&#xE70D;" 
                                      FontSize="10" 
                                      Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                      Visibility="Collapsed" />
                        </StackPanel>
                    </Button>
                    
                    <!-- Splitter Éditeur/Date -->
                    <controls:GridSplitter Grid.Column="5" 
                                           Width="3"
                                           ResizeBehavior="BasedOnAlignment"
                                           ResizeDirection="Columns"
                                           Background="{ThemeResource DividerStrokeColorDefaultBrush}"
                                           PointerPressed="GridSplitter_PointerPressed"
                                           PointerReleased="GridSplitter_PointerReleased"
                                           PointerCaptureLost="GridSplitter_PointerReleased" />
                    
                    <!-- Date d'installation -->
                    <Button Grid.Column="6" 
                            Style="{StaticResource SubtleButtonStyle}"
                            HorizontalAlignment="Left"
                            Padding="4,2"
                            Click="SortByDateHeader_Click"
                            ToolTipService.ToolTip="Trier par date d'installation">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="Date" 
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                            <FontIcon x:Name="SortDateIcon" 
                                      Glyph="&#xE70D;" 
                                      FontSize="10" 
                                      Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                      Visibility="Collapsed" />
                        </StackPanel>
                    </Button>
                    
                    <!-- Splitter Date/Taille -->
                    <controls:GridSplitter Grid.Column="7" 
                                           Width="3"
                                           ResizeBehavior="BasedOnAlignment"
                                           ResizeDirection="Columns"
                                           Background="{ThemeResource DividerStrokeColorDefaultBrush}"
                                           PointerPressed="GridSplitter_PointerPressed"
                                           PointerReleased="GridSplitter_PointerReleased"
                                           PointerCaptureLost="GridSplitter_PointerReleased" />
                    
                    <!-- Taille -->
                    <Button x:Name="SizeColumnHeader"
                            Grid.Column="8" 
                            Style="{StaticResource SubtleButtonStyle}"
                            HorizontalAlignment="Right"
                            Padding="4,2"
                            Click="SortBySizeHeader_Click"
                            ToolTipService.ToolTip="Trier par taille">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="Taille" 
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                            <FontIcon x:Name="SortSizeIcon" 
                                      Glyph="&#xE70D;" 
                                      FontSize="10" 
                                      Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                      Visibility="Collapsed" />
                        </StackPanel>
                    </Button>
                </Grid>

                <ListView x:Name="ProgramListView"
                          Grid.Row="3"
                          SelectionMode="Single"
                          SelectionChanged="ProgramListView_SelectionChanged"
                          DoubleTapped="ProgramListView_DoubleTapped"
                          Loaded="ProgramListView_Loaded"
                          ContainerContentChanging="ProgramListView_ContainerContentChanging">
                    <ListView.ItemContainerTransitions>
                        <TransitionCollection>
                            <AddDeleteThemeTransition />
                            <ReorderThemeTransition />
                        </TransitionCollection>
                    </ListView.ItemContainerTransitions>
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            <Setter Property="Padding" Value="0" />
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="models:InstalledProgram">
                            <Grid x:Name="ItemGrid" Padding="8,6"
                                  ToolTipService.ToolTip="{x:Bind InstallerType}">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="32" />     <!-- Checkbox -->
                                    <ColumnDefinition Width="40" />     <!-- Icône -->
                                    <ColumnDefinition Width="*" MinWidth="80" />  <!-- Nom -->
                                    <ColumnDefinition Width="3" />      <!-- Splitter space -->
                                    <ColumnDefinition Width="100" MinWidth="40" /> <!-- Éditeur -->
                                    <ColumnDefinition Width="3" />      <!-- Splitter space -->
                                    <ColumnDefinition Width="75" MinWidth="40" /> <!-- Date -->
                                    <ColumnDefinition Width="3" />      <!-- Splitter space -->
                                    <ColumnDefinition Width="60" MinWidth="40" />  <!-- Taille -->
                                </Grid.ColumnDefinitions>

                                <CheckBox IsChecked="{x:Bind IsSelected, Mode=TwoWay}"
                                          VerticalAlignment="Center"
                                          MinWidth="0" />

                                <!-- Icône du programme -->
                                <Grid Grid.Column="1" Width="28" Height="28" VerticalAlignment="Center">
                                    <Border Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                                            CornerRadius="4"
                                            Visibility="{x:Bind IconPlaceholderVisibility, Mode=OneWay}">
                                        <FontIcon Glyph="&#xE74C;" 
                                                  FontSize="14"
                                                  Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                    </Border>
                                    <Image Source="{x:Bind Icon, Mode=OneWay}" 
                                           Width="24" Height="24"
                                           Stretch="Uniform"
                                           Visibility="{x:Bind IconVisibility, Mode=OneWay}" />
                                </Grid>

                                <!-- Nom et badges -->
                                <Grid Grid.Column="2" VerticalAlignment="Center"
                                      ToolTipService.ToolTip="{x:Bind DisplayName}">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    
                                    <TextBlock Text="{x:Bind DisplayName}" 
                                               FontWeight="SemiBold"
                                               FontSize="13"
                                               TextTrimming="CharacterEllipsis"
                                               MaxLines="1" />
                                    
                                    <!-- Badges avec texte -->
                                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4" Margin="4,0,0,0">
                                        <Border Visibility="{x:Bind IsWindowsApp}"
                                                Background="{ThemeResource AccentFillColorDefaultBrush}"
                                                CornerRadius="4" Padding="5,2"
                                                ToolTipService.ToolTip="Application Windows Store">
                                            <TextBlock Text="MS" FontSize="9" FontWeight="SemiBold" Foreground="White" />
                                        </Border>
                                        <Border Visibility="{x:Bind IsSystemComponent}"
                                                Background="{ThemeResource SystemFillColorCautionBrush}"
                                                CornerRadius="4" Padding="5,2"
                                                ToolTipService.ToolTip="Composant système">
                                            <TextBlock Text="SYS" FontSize="9" FontWeight="SemiBold" />
                                        </Border>
                                    </StackPanel>
                                    
                                    <TextBlock Grid.Row="1" Grid.ColumnSpan="2"
                                               Text="{x:Bind Version}" 
                                               Style="{StaticResource CaptionTextBlockStyle}"
                                               FontSize="11"
                                               Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                               TextTrimming="CharacterEllipsis" />
                                </Grid>

                                <!-- Éditeur -->
                                <TextBlock Grid.Column="4" 
                                           Text="{x:Bind Publisher}" 
                                           FontSize="12"
                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                           TextTrimming="CharacterEllipsis"
                                           MaxLines="1"
                                           VerticalAlignment="Center"
                                           ToolTipService.ToolTip="{x:Bind Publisher}" />

                                <!-- Date d'installation -->
                                <TextBlock Grid.Column="6" 
                                           Text="{x:Bind FormattedInstallDate}" 
                                           FontSize="12"
                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                           TextTrimming="CharacterEllipsis"
                                           VerticalAlignment="Center" />

                                <!-- Taille -->
                                <Border Grid.Column="8" 
                                        Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                                        CornerRadius="3"
                                        Padding="6,2"
                                        VerticalAlignment="Center"
                                        HorizontalAlignment="Right">
                                    <TextBlock Text="{x:Bind FormattedSize}" 
                                               FontSize="11"
                                               FontFamily="Consolas" />
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>

                <!-- Loading overlay avec fond flou -->
                <Grid x:Name="LoadingOverlay" 
                      Grid.Row="3" 
                      Visibility="Collapsed">
                    <Grid.ChildrenTransitions>
                        <TransitionCollection>
                            <EntranceThemeTransition />
                        </TransitionCollection>
                    </Grid.ChildrenTransitions>
                    
                    <!-- Fond semi-transparent avec effet de flou -->
                    <Border Background="{ThemeResource AcrylicBackgroundFillColorDefaultBrush}" 
                            Opacity="0.95" />
                    
                    <!-- Panneau de chargement avec fond solide pour lisibilité -->
                    <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                            CornerRadius="12"
                            Padding="32"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            MinWidth="320">
                        <Border.Shadow>
                            <ThemeShadow />
                        </Border.Shadow>
                        <StackPanel Spacing="16">
                            <ProgressRing IsActive="True" Width="48" Height="48" />
                            <TextBlock x:Name="LoadingStatusText"
                                       Text="Chargement..."
                                       Style="{StaticResource SubtitleTextBlockStyle}"
                                       TextAlignment="Center" />
                            <ProgressBar x:Name="LoadingProgressBar"
                                         Value="0"
                                         Maximum="100"
                                         Width="250" />
                            <Button x:Name="CancelLoadingButton" 
                                    Content="Annuler" 
                                    Click="CancelLoading_Click"
                                    HorizontalAlignment="Center" />
                        </StackPanel>
                    </Border>
                </Grid>
            </Grid>

            <!-- GridSplitter pour redimensionner les panneaux -->
            <controls:GridSplitter Grid.Column="1" 
                                   Width="6"
                                   ResizeBehavior="BasedOnAlignment"
                                   ResizeDirection="Columns"
                                   Background="{ThemeResource ControlStrongFillColorDefaultBrush}" />

            <!-- Details Panel -->
            <Grid Grid.Column="2" Padding="16">
                <Grid.ChildrenTransitions>
                    <TransitionCollection>
                        <ContentThemeTransition HorizontalOffset="40" />
                    </TransitionCollection>
                </Grid.ChildrenTransitions>
                
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Program Details avec SettingsCards -->
                <StackPanel x:Name="DetailsPanel" Visibility="Collapsed" Spacing="12">
                    <StackPanel.ChildrenTransitions>
                        <TransitionCollection>
                            <EntranceThemeTransition IsStaggeringEnabled="True" />
                        </TransitionCollection>
                    </StackPanel.ChildrenTransitions>
                    
                    <!-- Header avec icône et nom -->
                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        
                        <Grid Width="56" Height="56" Margin="0,0,16,0">
                            <Border Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                                    CornerRadius="12">
                                <FontIcon x:Name="DetailIconPlaceholder" Glyph="&#xE74C;" FontSize="28"
                                          Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                            </Border>
                            <Image x:Name="DetailIcon" Width="48" Height="48" Stretch="Uniform" />
                        </Grid>
                        
                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                            <TextBlock x:Name="DetailNameText"
                                       FontWeight="SemiBold"
                                       FontSize="18"
                                       TextWrapping="Wrap"
                                       MaxLines="2" />
                            <TextBlock x:Name="DetailPublisherText"
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                        </StackPanel>
                    </Grid>

                    <!-- SettingsCards pour les informations -->
                    <ctControls:SettingsCard Header="Version" IsClickEnabled="False">
                        <ctControls:SettingsCard.HeaderIcon>
                            <FontIcon Glyph="&#xE8EC;" />
                        </ctControls:SettingsCard.HeaderIcon>
                        <TextBlock x:Name="DetailVersionText" 
                                   Style="{StaticResource BodyTextBlockStyle}" />
                    </ctControls:SettingsCard>

                    <ctControls:SettingsCard Header="Date d'installation" IsClickEnabled="False">
                        <ctControls:SettingsCard.HeaderIcon>
                            <FontIcon Glyph="&#xE787;" />
                        </ctControls:SettingsCard.HeaderIcon>
                        <TextBlock x:Name="DetailDateText" 
                                   Style="{StaticResource BodyTextBlockStyle}" />
                    </ctControls:SettingsCard>

                    <ctControls:SettingsCard Header="Taille" IsClickEnabled="False">
                        <ctControls:SettingsCard.HeaderIcon>
                            <FontIcon Glyph="&#xE7F8;" />
                        </ctControls:SettingsCard.HeaderIcon>
                        <TextBlock x:Name="DetailSizeText" 
                                   Style="{StaticResource BodyTextBlockStyle}"
                                   Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                   FontWeight="SemiBold" />
                    </ctControls:SettingsCard>

                    <ctControls:SettingsCard Header="Type d'installeur" IsClickEnabled="False">
                        <ctControls:SettingsCard.HeaderIcon>
                            <FontIcon Glyph="&#xE74C;" />
                        </ctControls:SettingsCard.HeaderIcon>
                        <TextBlock x:Name="DetailTypeText" 
                                   Style="{StaticResource BodyTextBlockStyle}" />
                    </ctControls:SettingsCard>

                    <!-- Emplacement avec SettingsExpander -->
                    <ctControls:SettingsExpander Header="Emplacement" IsExpanded="False">
                        <ctControls:SettingsExpander.HeaderIcon>
                            <FontIcon Glyph="&#xE8B7;" />
                        </ctControls:SettingsExpander.HeaderIcon>
                        <ctControls:SettingsExpander.Content>
                            <Button x:Name="OpenLocationButton" 
                                    Content="Ouvrir"
                                    Click="OpenLocationButton_Click"
                                    Style="{StaticResource AccentButtonStyle}" />
                        </ctControls:SettingsExpander.Content>
                        <ctControls:SettingsExpander.Items>
                            <ctControls:SettingsCard HorizontalContentAlignment="Left">
                                <TextBlock x:Name="DetailLocationText"
                                           Style="{StaticResource CaptionTextBlockStyle}"
                                           TextWrapping="Wrap"
                                           IsTextSelectionEnabled="True"
                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                            </ctControls:SettingsCard>
                        </ctControls:SettingsExpander.Items>
                    </ctControls:SettingsExpander>

                    <!-- Actions principales -->
                    <Grid Margin="0,8,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        
                        <Button Content="Analyser les résidus"
                                Click="ScanResidualsButton_Click"
                                ToolTipService.ToolTip="Rechercher et supprimer les fichiers résiduels"
                                Style="{StaticResource AccentButtonStyle}"
                                HorizontalAlignment="Stretch" />
                        
                        <Button x:Name="ModifyButton"
                                Grid.Column="1"
                                Content="Modifier"
                                Click="ModifyButton_Click"
                                Margin="8,0,0,0"
                                Visibility="Collapsed" />
                    </Grid>
                </StackPanel>

                <!-- Placeholder -->
                <StackPanel x:Name="PlaceholderPanel"
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center"
                            Spacing="12">
                    <StackPanel.ChildrenTransitions>
                        <TransitionCollection>
                            <EntranceThemeTransition />
                        </TransitionCollection>
                    </StackPanel.ChildrenTransitions>
                    
                    <Border Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                            CornerRadius="50"
                            Width="80" Height="80"
                            HorizontalAlignment="Center">
                        <FontIcon Glyph="&#xE8A5;" FontSize="36" 
                                  Foreground="{ThemeResource TextFillColorTertiaryBrush}" />
                    </Border>
                    <TextBlock Text="Sélectionnez un programme"
                               Style="{StaticResource SubtitleTextBlockStyle}"
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                               TextAlignment="Center" />
                    <TextBlock Text="pour voir ses détails et options"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                               TextAlignment="Center" />
                </StackPanel>

                <!-- Residuals List -->
                <Grid x:Name="ResidualsPanel" 
                      Grid.Row="1" 
                      Margin="0,16,0,0"
                      Visibility="Collapsed">
                    <Grid.ChildrenTransitions>
                        <TransitionCollection>
                            <EntranceThemeTransition />
                        </TransitionCollection>
                    </Grid.ChildrenTransitions>
                    
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Résidus trouvés" Style="{StaticResource SubtitleTextBlockStyle}" />
                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4">
                            <Button ToolTipService.ToolTip="Sélectionner confiance élevée" 
                                    Click="SelectHighConfidence_Click"
                                    Style="{StaticResource SubtleButtonStyle}" Padding="6">
                                <FontIcon Glyph="&#xE8FB;" FontSize="14" />
                            </Button>
                            <Button ToolTipService.ToolTip="Tout sélectionner/désélectionner"
                                    Click="ToggleSelectAllResiduals_Click"
                                    Style="{StaticResource SubtleButtonStyle}" Padding="6">
                                <FontIcon Glyph="&#xE762;" FontSize="14" />
                            </Button>
                        </StackPanel>
                    </Grid>

                    <!-- Légende confiance avec InfoBadge -->
                    <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="12" Margin="0,0,0,8">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <InfoBadge Style="{StaticResource SuccessIconInfoBadgeStyle}" Width="12" Height="12" />
                            <TextBlock Text="Très haute" Style="{StaticResource CaptionTextBlockStyle}" 
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <InfoBadge Style="{StaticResource InformationalIconInfoBadgeStyle}" Width="12" Height="12" />
                            <TextBlock Text="Haute" Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <InfoBadge Style="{StaticResource CautionIconInfoBadgeStyle}" Width="12" Height="12" />
                            <TextBlock Text="Moyenne" Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                        </StackPanel>
                    </StackPanel>

                    <ListView x:Name="ResidualsListView" Grid.Row="2" SelectionMode="None">
                        <ListView.ItemContainerTransitions>
                            <TransitionCollection>
                                <AddDeleteThemeTransition />
                            </TransitionCollection>
                        </ListView.ItemContainerTransitions>
                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="Padding" Value="0" />
                                <Setter Property="Margin" Value="0,1" />
                                <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            </Style>
                        </ListView.ItemContainerStyle>
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="models:ResidualItem">
                                <Grid Padding="4,6" ColumnSpacing="8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <CheckBox IsChecked="{x:Bind IsSelected, Mode=TwoWay}" MinWidth="20" VerticalAlignment="Center" />

                                    <!-- Indicateur de confiance avec convertisseur -->
                                    <Border Grid.Column="1" 
                                            Width="4" 
                                            CornerRadius="2"
                                            
                                            Background="{x:Bind ConfidenceBrush}" />

                                    <StackPanel Grid.Column="2" Spacing="2" VerticalAlignment="Center" Margin="4,0,0,0">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <FontIcon Glyph="{x:Bind TypeIcon}" FontSize="12"
                                                      Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                            <TextBlock Text="{x:Bind DisplayPath}"
                                                       TextTrimming="CharacterEllipsis"
                                                       ToolTipService.ToolTip="{x:Bind Path}"
                                                       Style="{StaticResource CaptionTextBlockStyle}" />
                                        </StackPanel>
                                        <TextBlock Text="{x:Bind TypeName}"
                                                   Style="{StaticResource CaptionTextBlockStyle}"
                                                   Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                                   FontSize="11" />
                                    </StackPanel>

                                    <TextBlock Grid.Column="3"
                                               Style="{StaticResource CaptionTextBlockStyle}"
                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                               Text="{x:Bind FormattedSize}"
                                               VerticalAlignment="Center" />
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </Grid>

                <!-- Cleanup Actions -->
                <Border x:Name="CleanupActionsPanel" 
                        Grid.Row="2"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        CornerRadius="8"
                        Padding="12"
                        Margin="0,12,0,0"
                        Visibility="Collapsed">
                    <Border.Transitions>
                        <TransitionCollection>
                            <EntranceThemeTransition />
                        </TransitionCollection>
                    </Border.Transitions>
                    
                    <StackPanel Spacing="12">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock x:Name="ResidualsCountText"
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       VerticalAlignment="Center" />
                            <TextBlock x:Name="ResidualsSizeText" Grid.Column="1"
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                       FontWeight="SemiBold"
                                       VerticalAlignment="Center" />
                        </Grid>

                        <Button Content="Nettoyer les résidus sélectionnés"
                                Click="CleanupResidualsButton_Click"
                                Style="{StaticResource AccentButtonStyle}"
                                HorizontalAlignment="Stretch" />
                    </StackPanel>
                </Border>
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <Grid Grid.Row="3" 
              Padding="16,10"
              Background="{ThemeResource LayerFillColorDefaultBrush}"
              BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
              BorderThickness="0,1,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <TextBlock x:Name="StatusText"
                       Text="Prêt"
                       Style="{StaticResource CaptionTextBlockStyle}"
                       VerticalAlignment="Center" />

            <TextBlock x:Name="TotalSizeText"
                       Grid.Column="1"
                       Style="{StaticResource CaptionTextBlockStyle}"
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                       VerticalAlignment="Center"
                       Margin="0,0,16,0" />

            <ProgressBar x:Name="StatusProgressBar"
                         Grid.Column="2"
                         Value="0"
                         Maximum="100"
                         Width="150"
                         Visibility="Collapsed" />
        </Grid>

        <!-- TeachingTip pour les nouveaux utilisateurs -->
        <TeachingTip x:Name="WelcomeTeachingTip"
                     Target="{x:Bind UninstallButton}"
                     Title="Bienvenue dans Clean Uninstaller"
                     Subtitle="Sélectionnez un programme et cliquez ici pour le désinstaller proprement. L'outil analysera ensuite les fichiers résiduels."
                     PreferredPlacement="Bottom"
                     IsLightDismissEnabled="True"
                     CloseButtonContent="Compris !"
                     ActionButtonContent="Ne plus afficher"
                     ActionButtonClick="WelcomeTeachingTip_ActionButtonClick" />

        <!-- Uninstall Overlay -->
        <Grid x:Name="UninstallOverlay"
              Grid.RowSpan="4"
              Background="{ThemeResource AcrylicBackgroundFillColorDefaultBrush}"
              Visibility="Collapsed">
            <Grid.ChildrenTransitions>
                <TransitionCollection>
                    <EntranceThemeTransition />
                </TransitionCollection>
            </Grid.ChildrenTransitions>
            
            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    CornerRadius="12"
                    Padding="32"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    MinWidth="400">
                <StackPanel Spacing="20">
                    <ProgressRing x:Name="UninstallProgressRing" IsActive="True" Width="56" Height="56" />
                    <TextBlock x:Name="UninstallStatusText"
                               Text="Désinstallation en cours..."
                               Style="{StaticResource SubtitleTextBlockStyle}"
                               TextAlignment="Center" />
                    <ProgressBar x:Name="UninstallProgressBar"
                                 Value="0"
                                 Maximum="100" />
                    <TextBlock x:Name="UninstallDetailText"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                               TextAlignment="Center"
                               TextWrapping="Wrap" />
                    <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Center">
                        <Button x:Name="ContinueUninstallButton"
                                Content="Continuer manuellement"
                                Click="ContinueUninstall_Click"
                                Visibility="Collapsed"
                                ToolTipService.ToolTip="Cliquez si le désinstalleur est terminé mais l'application ne le détecte pas" />
                        <Button x:Name="CancelUninstallButton"
                                Content="Annuler"
                                Click="CancelUninstall_Click" />
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Window>
