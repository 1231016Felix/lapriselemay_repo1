<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="CleanUninstaller.Views.InstallationMonitorPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:CleanUninstaller.Views"
    xmlns:models="using:CleanUninstaller.Models"
    xmlns:vm="using:CleanUninstaller.ViewModels"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="Transparent">

    <Grid Padding="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- En-tÃªte -->
        <StackPanel Grid.Row="0" Spacing="16" Margin="0,0,0,24">
            <TextBlock Text="Moniteur d'installation" 
                       Style="{StaticResource TitleTextBlockStyle}"
                       FontWeight="SemiBold"/>
            <TextBlock Text="Surveillez une installation pour une dÃ©sinstallation parfaite"
                       Style="{StaticResource BodyTextBlockStyle}"
                       Opacity="0.7"/>
        </StackPanel>

        <!-- Contenu principal -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="16"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Panneau gauche: ContrÃ´les du monitoring -->
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Carte de contrÃ´le -->
                <Border Grid.Row="0" 
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="20">
                    <StackPanel Spacing="16">
                        <TextBlock Text="Nouvelle surveillance" 
                                   Style="{StaticResource SubtitleTextBlockStyle}"
                                   FontWeight="SemiBold"/>

                        <!-- Nom de l'installation -->
                        <StackPanel Spacing="4">
                            <TextBlock Text="Nom de l'application" Opacity="0.7"/>
                            <TextBox x:Name="InstallationNameBox"
                                     PlaceholderText="Ex: Visual Studio Code, Notepad++..."
                                     Text="{x:Bind ViewModel.InstallationName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     IsEnabled="{x:Bind ViewModel.CanStart, Mode=OneWay}"/>
                        </StackPanel>

                        <!-- Chemin de l'installeur (optionnel) -->
                        <StackPanel Spacing="4">
                            <TextBlock Text="Chemin de l'installeur (optionnel)" Opacity="0.7"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox Grid.Column="0"
                                         PlaceholderText="C:\Downloads\setup.exe"
                                         Text="{x:Bind ViewModel.InstallerPath, Mode=TwoWay}"
                                         IsEnabled="{x:Bind ViewModel.CanStart, Mode=OneWay}"/>
                                <Button Grid.Column="1" 
                                        Content="..." 
                                        Margin="8,0,0,0"
                                        Click="BrowseInstaller_Click"
                                        IsEnabled="{x:Bind ViewModel.CanStart, Mode=OneWay}"/>
                            </Grid>
                        </StackPanel>

                        <!-- Boutons de contrÃ´le -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="8"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <Button Grid.Column="0"
                                    Content="ðŸ”´ DÃ©marrer la surveillance"
                                    Command="{x:Bind ViewModel.StartMonitoringCommand}"
                                    Style="{StaticResource AccentButtonStyle}"
                                    HorizontalAlignment="Stretch"
                                    Padding="16,10"/>

                            <Button Grid.Column="2"
                                    Content="â¹ï¸ ArrÃªter et analyser"
                                    Command="{x:Bind ViewModel.StopMonitoringCommand}"
                                    HorizontalAlignment="Stretch"
                                    Padding="16,10"/>
                        </Grid>

                        <!-- Boutons secondaires -->
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button Content="â¸ï¸ Pause" 
                                    Command="{x:Bind ViewModel.PauseMonitoringCommand}"/>
                            <Button Content="â–¶ï¸ Reprendre" 
                                    Command="{x:Bind ViewModel.ResumeMonitoringCommand}"/>
                            <Button Content="âŒ Annuler" 
                                    Command="{x:Bind ViewModel.CancelMonitoringCommand}"/>
                        </StackPanel>

                        <!-- Barre de progression -->
                        <StackPanel Spacing="8" 
                                    Visibility="{x:Bind ViewModel.IsBusy, Mode=OneWay}">
                            <ProgressBar Value="{x:Bind ViewModel.Progress, Mode=OneWay}"
                                         IsIndeterminate="{x:Bind ViewModel.IsBusy, Mode=OneWay}"
                                         Maximum="100"/>
                            <TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Opacity="0.7"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Statut actuel -->
                <Border Grid.Row="1" 
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="20"
                        Margin="0,16,0,0"
                        Visibility="{x:Bind ViewModel.HasCurrentMonitoring, Mode=OneWay}">
                    <StackPanel Spacing="12">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <FontIcon Grid.Column="0" 
                                      Glyph="{x:Bind ViewModel.CurrentMonitoring.StatusIcon, Mode=OneWay, FallbackValue=''}"
                                      FontSize="24"
                                      Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>

                            <StackPanel Grid.Column="1" Margin="12,0,0,0">
                                <TextBlock Text="{x:Bind ViewModel.CurrentMonitoring.Name, Mode=OneWay, FallbackValue='En attente'}"
                                           Style="{StaticResource SubtitleTextBlockStyle}"/>
                                <TextBlock Text="{x:Bind ViewModel.CurrentMonitoring.StatusText, Mode=OneWay, FallbackValue=''}"
                                           Style="{StaticResource CaptionTextBlockStyle}"
                                           Opacity="0.7"/>
                            </StackPanel>
                        </Grid>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="DurÃ©e" Style="{StaticResource CaptionTextBlockStyle}" Opacity="0.5"/>
                                <TextBlock Text="{x:Bind ViewModel.CurrentMonitoring.FormattedDuration, Mode=OneWay, FallbackValue='0s'}"
                                           Style="{StaticResource BodyStrongTextBlockStyle}"/>
                            </StackPanel>

                            <StackPanel Grid.Column="1">
                                <TextBlock Text="Changements dÃ©tectÃ©s" Style="{StaticResource CaptionTextBlockStyle}" Opacity="0.5"/>
                                <TextBlock Text="{x:Bind ViewModel.RealTimeChangeCount, Mode=OneWay}"
                                           Style="{StaticResource BodyStrongTextBlockStyle}"/>
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Liste des changements en temps rÃ©el -->
                <Border Grid.Row="2" 
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Margin="0,16,0,0"
                        Visibility="{x:Bind ViewModel.HasCurrentMonitoring, Mode=OneWay}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" 
                                   Text="ðŸ“Š Changements en temps rÃ©el" 
                                   Style="{StaticResource SubtitleTextBlockStyle}"
                                   Margin="20,16,20,8"/>

                        <ListView Grid.Row="1" 
                                  ItemsSource="{x:Bind ViewModel.RealTimeChanges, Mode=OneWay}"
                                  SelectionMode="None"
                                  Padding="8">
                            <ListView.ItemTemplate>
                                <DataTemplate x:DataType="models:SystemChange">
                                    <Grid Padding="8,4" ColumnSpacing="8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <FontIcon Grid.Column="0" 
                                                  Glyph="{x:Bind ChangeTypeIcon}" 
                                                  FontSize="12"
                                                  Foreground="{x:Bind ChangeTypeColor}"/>
                                        
                                        <FontIcon Grid.Column="1" 
                                                  Glyph="{x:Bind CategoryIcon}" 
                                                  FontSize="12"
                                                  Opacity="0.6"/>

                                        <TextBlock Grid.Column="2" 
                                                   Text="{x:Bind DisplayPath}" 
                                                   TextTrimming="CharacterEllipsis"
                                                   ToolTipService.ToolTip="{x:Bind Path}"/>

                                        <TextBlock Grid.Column="3" 
                                                   Text="{x:Bind FormattedTimestamp}" 
                                                   Opacity="0.5"
                                                   Style="{StaticResource CaptionTextBlockStyle}"/>
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Grid>
                </Border>
            </Grid>

            <!-- Panneau droit: Installations sauvegardÃ©es -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- En-tÃªte -->
                <StackPanel Grid.Row="0" Spacing="8" Margin="0,0,0,16">
                    <TextBlock Text="ðŸ“ Installations surveillÃ©es" 
                               Style="{StaticResource SubtitleTextBlockStyle}"
                               FontWeight="SemiBold"/>
                    <TextBlock Text="SÃ©lectionnez une installation pour la dÃ©sinstaller parfaitement"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Opacity="0.7"/>
                </StackPanel>

                <!-- Liste des installations -->
                <ListView Grid.Row="1" 
                          ItemsSource="{x:Bind ViewModel.SavedInstallations, Mode=OneWay}"
                          SelectedItem="{x:Bind ViewModel.SelectedInstallation, Mode=TwoWay}"
                          SelectionMode="Single">
                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="models:MonitoredInstallation">
                            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                    CornerRadius="6"
                                    Padding="12"
                                    Margin="0,4">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <!-- Nom et statut -->
                                    <StackPanel Grid.Column="0" Grid.Row="0" Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="{x:Bind Name}" 
                                                   Style="{StaticResource BodyStrongTextBlockStyle}"/>
                                        <Border Background="{ThemeResource AccentFillColorDefaultBrush}"
                                                CornerRadius="4"
                                                Padding="6,2"
                                                Visibility="{x:Bind IsUninstalled}">
                                            <TextBlock Text="DÃ©sinstallÃ©" 
                                                       FontSize="10"
                                                       Foreground="White"/>
                                        </Border>
                                    </StackPanel>

                                    <!-- Bouton supprimer -->
                                    <Button Grid.Column="1" Grid.Row="0"
                                            Content="ðŸ—‘ï¸"
                                            Background="Transparent"
                                            Click="DeleteInstallation_Click"
                                            Tag="{x:Bind}"
                                            ToolTipService.ToolTip="Supprimer"/>

                                    <!-- Statistiques -->
                                    <TextBlock Grid.Column="0" Grid.Row="1" Grid.ColumnSpan="2"
                                               Opacity="0.7"
                                               Style="{StaticResource CaptionTextBlockStyle}">
                                        <Run Text="{x:Bind Statistics.TotalChanges}"/>
                                        <Run Text="changements â€¢"/>
                                        <Run Text="{x:Bind FormattedTotalSize}"/>
                                    </TextBlock>

                                    <!-- Date -->
                                    <TextBlock Grid.Column="0" Grid.Row="2" Grid.ColumnSpan="2"
                                               Opacity="0.5"
                                               Style="{StaticResource CaptionTextBlockStyle}">
                                        <Run Text="SurveillÃ© le"/>
                                        <Run Text="{x:Bind StartTime}"/>
                                    </TextBlock>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>

                <!-- Actions pour l'installation sÃ©lectionnÃ©e -->
                <Border Grid.Row="2" 
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="16"
                        Margin="0,16,0,0"
                        Visibility="{x:Bind ViewModel.HasSelectedInstallation, Mode=OneWay}">
                    <StackPanel Spacing="12">
                        <TextBlock Text="Actions" Style="{StaticResource SubtitleTextBlockStyle}"/>

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button Content="ðŸ§¹ DÃ©sinstallation parfaite"
                                    Command="{x:Bind ViewModel.PerfectUninstallCommand}"
                                    Style="{StaticResource AccentButtonStyle}"/>
                            <Button Content="ðŸ“¤ Exporter"
                                    Command="{x:Bind ViewModel.ExportChangesCommand}"/>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button Content="âœ… Tout sÃ©lectionner"
                                    Command="{x:Bind ViewModel.SelectAllChangesCommand}"/>
                            <Button Content="â¬œ Tout dÃ©sÃ©lectionner"
                                    Command="{x:Bind ViewModel.DeselectAllChangesCommand}"/>
                            <Button Content="ðŸ“ Fichiers seulement"
                                    Command="{x:Bind ViewModel.SelectFilesOnlyCommand}"/>
                        </StackPanel>

                        <!-- RÃ©sumÃ© des changements -->
                        <StackPanel Spacing="4" 
                                    Visibility="{x:Bind ViewModel.HasSelectedInstallation, Mode=OneWay}">
                            <TextBlock Text="RÃ©sumÃ© des changements :" 
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Opacity="0.7"/>
                            <TextBlock Style="{StaticResource CaptionTextBlockStyle}">
                                <Run Text="â€¢ Fichiers:"/>
                                <Run Text="{x:Bind ViewModel.SelectedInstallation.Statistics.FilesCreated, Mode=OneWay, FallbackValue='0'}"/>
                                <Run Text=" crÃ©Ã©s,"/>
                                <Run Text="{x:Bind ViewModel.SelectedInstallation.Statistics.FilesModified, Mode=OneWay, FallbackValue='0'}"/>
                                <Run Text=" modifiÃ©s"/>
                            </TextBlock>
                            <TextBlock Style="{StaticResource CaptionTextBlockStyle}">
                                <Run Text="â€¢ Dossiers:"/>
                                <Run Text="{x:Bind ViewModel.SelectedInstallation.Statistics.FoldersCreated, Mode=OneWay, FallbackValue='0'}"/>
                                <Run Text=" crÃ©Ã©s"/>
                            </TextBlock>
                            <TextBlock Style="{StaticResource CaptionTextBlockStyle}">
                                <Run Text="â€¢ Registre:"/>
                                <Run Text="{x:Bind ViewModel.SelectedInstallation.Statistics.RegistryKeysCreated, Mode=OneWay, FallbackValue='0'}"/>
                                <Run Text=" clÃ©s,"/>
                                <Run Text="{x:Bind ViewModel.SelectedInstallation.Statistics.RegistryValuesCreated, Mode=OneWay, FallbackValue='0'}"/>
                                <Run Text=" valeurs"/>
                            </TextBlock>
                            <TextBlock Style="{StaticResource CaptionTextBlockStyle}">
                                <Run Text="â€¢ Services:"/>
                                <Run Text="{x:Bind ViewModel.SelectedInstallation.Statistics.ServicesCreated, Mode=OneWay, FallbackValue='0'}"/>
                            </TextBlock>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</Page>
