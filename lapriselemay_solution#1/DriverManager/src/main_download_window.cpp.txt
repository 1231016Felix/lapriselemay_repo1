// ============================================================================
// INSERT THIS CODE BEFORE "// Render status bar" IN main.cpp
// ============================================================================

// Render download manager window
void RenderDownloadWindow(AppState& state) {
    if (!state.showDownloadWindow) return;
    
    ImGui::SetNextWindowSize(ImVec2(800, 500), ImGuiCond_FirstUseEver);
    if (ImGui::Begin("Gestionnaire de telechargements", &state.showDownloadWindow)) {
        
        auto tasks = state.driverDownloader.GetAllTasks();
        
        // Header with statistics
        int queued = state.driverDownloader.GetQueuedCount();
        int active = state.driverDownloader.GetActiveCount();
        int completed = state.driverDownloader.GetCompletedCount();
        int failed = state.driverDownloader.GetFailedCount();
        
        ImGui::TextColored(ImVec4(0.4f, 0.7f, 1.0f, 1.0f), "File d'attente des pilotes");
        ImGui::Separator();
        ImGui::Spacing();
        
        ImGui::Text("En attente: %d | Actifs: %d | Termines: %d | Echecs: %d", 
            queued, active, completed, failed);
        
        ImGui::Spacing();
        
        // Control buttons
        bool isDownloading = state.driverDownloader.IsDownloading();
        bool isPaused = state.driverDownloader.IsPaused();
        
        if (!isDownloading && queued > 0) {
            if (ImGui::Button("Demarrer les telechargements")) {
                state.driverDownloader.StartDownloads();
            }
        } else if (isDownloading && !isPaused) {
            if (ImGui::Button("Pause")) {
                state.driverDownloader.PauseDownloads();
            }
        } else if (isPaused) {
            if (ImGui::Button("Reprendre")) {
                state.driverDownloader.ResumeDownloads();
            }
        }
        
        ImGui::SameLine();
        ImGui::BeginDisabled(!isDownloading && queued == 0);
        if (ImGui::Button("Tout annuler")) {
            state.driverDownloader.CancelAll();
        }
        ImGui::EndDisabled();
        
        ImGui::SameLine();
        if (ImGui::Button("Nettoyer termines")) {
            state.driverDownloader.ClearCompleted();
        }
        
        ImGui::Spacing();
        ImGui::Separator();
        ImGui::Spacing();
        
        // Installation options
        ImGui::Checkbox("Creer un point de restauration avant installation", &state.createRestorePoint);
        if (ImGui::IsItemHovered()) {
            ImGui::SetTooltip("Recommande pour pouvoir revenir en arriere en cas de probleme");
        }
        
        ImGui::Spacing();
        
        // Install all ready button
        int readyCount = 0;
        for (const auto& task : tasks) {
            if (task.state == DriverManager::DownloadState::ReadyToInstall && task.selected) {
                readyCount++;
            }
        }
        
        ImGui::BeginDisabled(readyCount == 0);
        ImGui::PushStyleColor(ImGuiCol_Button, ImVec4(0.2f, 0.6f, 0.2f, 0.7f));
        ImGui::PushStyleColor(ImGuiCol_ButtonHovered, ImVec4(0.3f, 0.7f, 0.3f, 0.85f));
        ImGui::PushStyleColor(ImGuiCol_ButtonActive, ImVec4(0.4f, 0.8f, 0.4f, 1.0f));
        char installBtnLabel[64];
        snprintf(installBtnLabel, sizeof(installBtnLabel), "Installer %d pilote(s) pret(s)", readyCount);
        if (ImGui::Button(installBtnLabel, ImVec2(250, 0))) {
            DriverManager::InstallOptions options;
            options.createRestorePoint = state.createRestorePoint;
            state.driverDownloader.InstallAllReady(options);
        }
        ImGui::PopStyleColor(3);
        ImGui::EndDisabled();
        
        ImGui::Spacing();
        ImGui::Separator();
        ImGui::Spacing();
        
        // Task table
        if (tasks.empty()) {
            ImGui::TextColored(ImVec4(0.5f, 0.5f, 0.5f, 1.0f), 
                "Aucun telechargement en cours.\n\n"
                "Pour ajouter des pilotes :\n"
                "1. Selectionnez un pilote dans la liste principale\n"
                "2. Cliquez sur 'Telecharger MAJ' dans le panneau de details");
        } else if (ImGui::BeginTable("DownloadsTable", 6, 
            ImGuiTableFlags_Borders | ImGuiTableFlags_RowBg | ImGuiTableFlags_ScrollY)) {
            
            ImGui::TableSetupScrollFreeze(0, 1);
            ImGui::TableSetupColumn("", ImGuiTableColumnFlags_WidthFixed, 30.0f);
            ImGui::TableSetupColumn("Pilote", ImGuiTableColumnFlags_WidthStretch);
            ImGui::TableSetupColumn("Version", ImGuiTableColumnFlags_WidthFixed, 100.0f);
            ImGui::TableSetupColumn("Progression", ImGuiTableColumnFlags_WidthFixed, 150.0f);
            ImGui::TableSetupColumn("Etat", ImGuiTableColumnFlags_WidthFixed, 120.0f);
            ImGui::TableSetupColumn("Actions", ImGuiTableColumnFlags_WidthFixed, 100.0f);
            ImGui::TableHeadersRow();
            
            int rowIdx = 0;
            for (auto& task : tasks) {
                ImGui::TableNextRow();
                ImGui::PushID(rowIdx++);
                
                // Checkbox column
                ImGui::TableNextColumn();
                bool canSelect = (task.state == DriverManager::DownloadState::ReadyToInstall);
                ImGui::BeginDisabled(!canSelect);
                bool selected = task.selected;
                if (ImGui::Checkbox("##sel", &selected)) {
                    auto* t = state.driverDownloader.GetTask(task.taskId);
                    if (t) t->selected = selected;
                }
                ImGui::EndDisabled();
                
                // Device name
                ImGui::TableNextColumn();
                ImGui::TextWrapped("%s", DriverManager::WideToUtf8(task.deviceName).c_str());
                
                // Version
                ImGui::TableNextColumn();
                ImGui::Text("%s -> %s", 
                    DriverManager::WideToUtf8(task.currentVersion).c_str(),
                    DriverManager::WideToUtf8(task.newVersion).c_str());
                
                // Progress bar
                ImGui::TableNextColumn();
                if (task.state == DriverManager::DownloadState::Downloading) {
                    char progressText[64];
                    snprintf(progressText, sizeof(progressText), "%.0f%% (%s)", 
                        task.progress * 100.0f, 
                        DriverManager::WideToUtf8(DriverManager::FormatBytes(task.downloadedBytes)).c_str());
                    ImGui::ProgressBar(task.progress, ImVec2(-1, 0), progressText);
                } else if (task.state == DriverManager::DownloadState::Queued) {
                    ImGui::ProgressBar(0.0f, ImVec2(-1, 0), "En attente...");
                } else if (task.state == DriverManager::DownloadState::Completed) {
                    ImGui::ProgressBar(1.0f, ImVec2(-1, 0), "100%");
                } else if (task.state == DriverManager::DownloadState::ReadyToInstall) {
                    ImGui::ProgressBar(1.0f, ImVec2(-1, 0), "Pret");
                } else {
                    ImGui::ProgressBar(task.progress, ImVec2(-1, 0), "");
                }
                
                // State
                ImGui::TableNextColumn();
                ImVec4 stateColor;
                switch (task.state) {
                    case DriverManager::DownloadState::Completed:
                        stateColor = ImVec4(0.2f, 0.8f, 0.2f, 1.0f);
                        break;
                    case DriverManager::DownloadState::Failed:
                        stateColor = ImVec4(0.9f, 0.2f, 0.2f, 1.0f);
                        break;
                    case DriverManager::DownloadState::Downloading:
                    case DriverManager::DownloadState::Installing:
                        stateColor = ImVec4(0.3f, 0.6f, 0.9f, 1.0f);
                        break;
                    case DriverManager::DownloadState::ReadyToInstall:
                        stateColor = ImVec4(0.9f, 0.7f, 0.2f, 1.0f);
                        break;
                    default:
                        stateColor = ImVec4(0.6f, 0.6f, 0.6f, 1.0f);
                }
                ImGui::TextColored(stateColor, "%s", 
                    DriverManager::WideToUtf8(DriverManager::GetStateText(task.state)).c_str());
                
                if (task.state == DriverManager::DownloadState::Failed && !task.errorMessage.empty()) {
                    if (ImGui::IsItemHovered()) {
                        ImGui::SetTooltip("%s", DriverManager::WideToUtf8(task.errorMessage).c_str());
                    }
                }
                
                // Actions
                ImGui::TableNextColumn();
                if (task.state == DriverManager::DownloadState::Failed || 
                    task.state == DriverManager::DownloadState::Cancelled) {
                    if (ImGui::SmallButton("Reessayer")) {
                        state.driverDownloader.RetryTask(task.taskId);
                    }
                } else if (task.state == DriverManager::DownloadState::ReadyToInstall) {
                    if (ImGui::SmallButton("Installer")) {
                        DriverManager::InstallOptions options;
                        options.createRestorePoint = state.createRestorePoint;
                        state.driverDownloader.InstallDriver(task.taskId, options);
                    }
                } else if (task.state == DriverManager::DownloadState::Downloading) {
                    if (ImGui::SmallButton("Annuler")) {
                        state.driverDownloader.CancelTask(task.taskId);
                    }
                } else if (task.state == DriverManager::DownloadState::Queued) {
                    if (ImGui::SmallButton("Retirer")) {
                        state.driverDownloader.RemoveFromQueue(task.taskId);
                    }
                }
                
                ImGui::PopID();
            }
            
            ImGui::EndTable();
        }
    }
    ImGui::End();
}

