<Window x:Class="QuickLauncher.Views.LauncherWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:QuickLauncher.ViewModels"
        xmlns:models="clr-namespace:QuickLauncher.Models"
        xmlns:converters="clr-namespace:QuickLauncher.Converters"
        Title="QuickLauncher"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        ShowInTaskbar="False"
        Topmost="True"
        WindowStartupLocation="Manual"
        Width="680"
        SizeToContent="Height"
        MaxHeight="600"
        ResizeMode="NoResize"
        Deactivated="Window_Deactivated"
        PreviewKeyDown="Window_PreviewKeyDown"
        Loaded="Window_Loaded"
        UseLayoutRounding="True"
        SnapsToDevicePixels="True"
        TextOptions.TextFormattingMode="Display">
    
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:IconToVisibilityConverter x:Key="IconToVis"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVis"/>
        <converters:ResultTypeToMenuVisibilityConverter x:Key="TypeToMenuVis"/>
        <converters:NullToVisibilityConverter x:Key="NullToVis"/>
        <converters:PreviewTypeToVisibilityConverter x:Key="PreviewTypeToVis"/>
        <converters:ResultTypeToBadgeTextConverter x:Key="TypeToBadgeText"/>
        <converters:ResultTypeToBadgeColorConverter x:Key="TypeToBadgeColor"/>
        <converters:AlternationToShortcutConverter x:Key="AltShortcut"/>
        <converters:AlternationToShortcutVisibilityConverter x:Key="AltShortcutVis"/>
        
        <!-- Style bouton clear discret -->
        <Style x:Key="ClearButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="#555"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="ToolTip" Value="Effacer la recherche"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Foreground" Value="#AAA"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        
        <!-- Style bouton settings discret -->
        <Style x:Key="SettingsButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="#666"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="ToolTip" Value="ParamÃ¨tres (Ctrl+,)"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Foreground" Value="#AAA"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        
        
        <!-- Style menu contextuel avec thÃ¨me (sans gutter/bande blanche) -->
        <Style x:Key="DarkContextMenuStyle" TargetType="ContextMenu">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
            <Setter Property="Padding" Value="4"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ContextMenu">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="6"
                                Padding="{TemplateBinding Padding}"
                                SnapsToDevicePixels="True">
                            <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- Style MenuItem sans gutter (bande blanche) -->
        <Style x:Key="DarkMenuItemStyle" TargetType="MenuItem">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="MenuItem">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderThickness="0"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}"
                                Margin="2">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <ContentPresenter Grid.Column="0"
                                                  ContentSource="Header"
                                                  RecognizesAccessKey="True"
                                                  VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="1"
                                           Text="{TemplateBinding InputGestureText}"
                                           Foreground="{DynamicResource TextTertiaryBrush}"
                                           FontSize="11"
                                           Margin="20,0,0,0"
                                           VerticalAlignment="Center"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{DynamicResource HoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Foreground" Value="{DynamicResource TextTertiaryBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- Style pour les actions secondaires -->
        <Style x:Key="ActionItemStyle" TargetType="ListBoxItem">
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                CornerRadius="6"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{DynamicResource AccentBrush}"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{DynamicResource HoverBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- Menu contextuel pour les rÃ©sultats (gÃ©nÃ©rÃ© dynamiquement) -->
        <ContextMenu x:Key="ResultContextMenu" Style="{StaticResource DarkContextMenuStyle}"
                     Opened="ResultContextMenu_Opened"/>
    </Window.Resources>
    
    <Grid Margin="20">
        <!-- Couche d'ombre sÃ©parÃ©e: rasterisÃ©e Ã  demi-rÃ©solution via BitmapCache
             (l'ombre n'a pas besoin d'Ãªtre nette â†’ RenderAtScale=0.5 divise le coÃ»t par 4) -->
        <Border x:Name="ShadowBorder"
                CornerRadius="12"
                Background="{DynamicResource BackgroundBrush}"
                Opacity="0"
                IsHitTestVisible="False">
            <Border.CacheMode>
                <BitmapCache EnableClearType="False" RenderAtScale="0.5"/>
            </Border.CacheMode>
            <Border.Effect>
                <DropShadowEffect BlurRadius="12" 
                                  ShadowDepth="0" 
                                  Opacity="0.5" 
                                  Color="Black"/>
            </Border.Effect>
        </Border>
        
        <!-- Contenu principal: PAS d'Effect â†’ animations GPU-friendly -->
        <Border x:Name="MainBorder"
                Background="{DynamicResource BackgroundBrush}" 
                CornerRadius="12" 
                BorderBrush="{DynamicResource BorderBrush}" 
                BorderThickness="1"
                Opacity="0"
                RenderTransformOrigin="0.5,0">
            <Border.RenderTransform>
                <TransformGroup>
                    <ScaleTransform x:Name="MainBorderScale" ScaleX="1" ScaleY="1"/>
                    <TranslateTransform x:Name="MainBorderTranslate" Y="-6"/>
                </TransformGroup>
            </Border.RenderTransform>
        
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <!-- Barre de recherche -->
            <Border Grid.Row="0" 
                    Background="{DynamicResource SurfaceBrush}" 
                    CornerRadius="12,12,0,0"
                    Padding="16">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- IcÃ´ne recherche / indicateur de chargement -->
                    <TextBlock Grid.Column="0"
                               FontSize="20"
                               VerticalAlignment="Center"
                               Margin="0,0,12,0">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Text" Value="ðŸ”"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsSearching}" Value="True">
                                        <Setter Property="Text" Value="â³"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                    
                    <TextBox x:Name="SearchBox"
                             Grid.Column="1"
                             Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                             FontSize="18"
                             Foreground="{DynamicResource TextPrimaryBrush}"
                             Background="Transparent"
                             BorderThickness="0"
                             CaretBrush="{DynamicResource TextPrimaryBrush}"
                             VerticalAlignment="Center"/>
                    
                    <!-- Bouton Clear -->
                    <Button x:Name="ClearButton"
                            Grid.Column="2"
                            Content="âœ•"
                            Style="{StaticResource ClearButtonStyle}"
                            Click="ClearButton_Click"
                            Visibility="Collapsed"/>
                    
                    <!-- Bouton Settings discret -->
                    <Button x:Name="SettingsButton"
                            Grid.Column="3"
                            Content="âš™ï¸"
                            Style="{StaticResource SettingsButtonStyle}"
                            Click="SettingsButton_Click"
                            Visibility="{Binding ShowSettingsButton, FallbackValue=Visible}"/>
                </Grid>
            </Border>
            
            <!-- Zone principale: RÃ©sultats -->
            <Grid Grid.Row="1">
                <!-- Liste des rÃ©sultats -->
                <ListBox x:Name="ResultsList"
                         ItemsSource="{Binding Results}"
                         SelectedIndex="{Binding SelectedIndex, Mode=TwoWay}"
                         AlternationCount="15"
                         Background="Transparent"
                         BorderThickness="0"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         VirtualizingPanel.IsVirtualizing="True"
                         VirtualizingPanel.VirtualizationMode="Recycling"
                         VirtualizingPanel.ScrollUnit="Pixel"
                         VirtualizingPanel.CacheLength="2,2"
                         VirtualizingPanel.CacheLengthUnit="Page"
                         ScrollViewer.CanContentScroll="True"
                         MouseDoubleClick="ResultsList_MouseDoubleClick"
                         PreviewMouseLeftButtonUp="ResultsList_PreviewMouseLeftButtonUp"
                         Visibility="{Binding HasResults, Converter={StaticResource BoolToVis}}"
                         ScrollViewer.IsDeferredScrollingEnabled="False">
                    
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="12,10"/>
                            <Setter Property="Margin" Value="4,2"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                            <Setter Property="ContextMenu" Value="{StaticResource ResultContextMenu}"/>
                            <Setter Property="Opacity" Value="0"/>
                            <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
                            <Setter Property="RenderTransform">
                                <Setter.Value>
                                    <TransformGroup>
                                        <ScaleTransform ScaleX="1" ScaleY="1"/>
                                        <TranslateTransform Y="0"/>
                                    </TransformGroup>
                                </Setter.Value>
                            </Setter>
                            <EventSetter Event="Loaded" Handler="ResultItem_Loaded"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border x:Name="Bd"
                                                Background="{TemplateBinding Background}"
                                                CornerRadius="8"
                                                Padding="{TemplateBinding Padding}">
                                            <ContentPresenter/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="Bd" Property="Background" Value="{DynamicResource AccentBrush}"/>
                                            </Trigger>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Bd" Property="Background" Value="{DynamicResource HoverBrush}"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>
                    
                    <ListBox.ItemTemplate>
                        <DataTemplate DataType="{x:Type models:SearchResult}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- IcÃ´ne native (si disponible) -->
                                <Image Grid.Column="0"
                                       Source="{Binding NativeIcon}"
                                       Width="32"
                                       Height="32"
                                       VerticalAlignment="Center"
                                       Margin="0,0,12,0"
                                       RenderOptions.BitmapScalingMode="Fant"
                                       RenderOptions.CachingHint="Cache">
                                    <Image.Style>
                                        <Style TargetType="Image">
                                            <Setter Property="Visibility" Value="{Binding NativeIcon, Converter={StaticResource IconToVis}, ConverterParameter=Native}"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsInfoBlock}" Value="True">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Image.Style>
                                </Image>
                                
                                <!-- IcÃ´ne emoji (fallback) -->
                                <TextBlock Grid.Column="0"
                                           Text="{Binding DisplayIcon}"
                                           FontFamily="Segoe UI Emoji"
                                           FontSize="24"
                                           VerticalAlignment="Center"
                                           Margin="0,0,12,0">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Visibility" Value="{Binding NativeIcon, Converter={StaticResource IconToVis}, ConverterParameter=Emoji}"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsInfoBlock}" Value="True">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                                
                                <!-- Badge de catÃ©gorie -->
                                <Border x:Name="CategoryBadge"
                                        Grid.Column="1"
                                        Background="{Binding Type, Converter={StaticResource TypeToBadgeColor}}"
                                        CornerRadius="3"
                                        Padding="5,2"
                                        Margin="0,0,10,0"
                                        VerticalAlignment="Center">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Visibility" Value="{Binding DataContext.ShowCategoryBadges, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BoolToVis}, FallbackValue=Collapsed}"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsInfoBlock}" Value="True">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <TextBlock Text="{Binding Type, Converter={StaticResource TypeToBadgeText}}"
                                               FontSize="9"
                                               FontWeight="Bold"
                                               Foreground="White"/>
                                </Border>
                                
                                <StackPanel Grid.Column="2" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding Name}"
                                               FontSize="14"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               TextTrimming="CharacterEllipsis"/>
                                    <TextBlock Text="{Binding Description}"
                                               FontSize="11"
                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                               TextTrimming="CharacterEllipsis"
                                               Margin="0,2,0,0"/>
                                </StackPanel>
                                
                                <!-- Raccourcis contextuels quand sÃ©lectionnÃ© -->
                                <StackPanel Grid.Column="3" 
                                            Orientation="Horizontal"
                                            VerticalAlignment="Center"
                                            Visibility="{Binding IsSelected, 
                                                RelativeSource={RelativeSource AncestorType=ListBoxItem},
                                                Converter={StaticResource BoolToVis}}">
                                    <!-- Ctrl+Enter pour Admin (apps/scripts) -->
                                    <Border Background="{DynamicResource HoverBrush}"
                                            CornerRadius="3"
                                            Padding="4,2"
                                            Margin="0,0,4,0"
                                            ToolTip="ExÃ©cuter en tant qu'administrateur"
                                            Visibility="{Binding Type, Converter={StaticResource TypeToMenuVis}, ConverterParameter=RunAsAdmin}">
                                        <TextBlock Text="Ctrl+â†µ Admin"
                                                   FontSize="9"
                                                   Foreground="{DynamicResource TextTertiaryBrush}"/>
                                    </Border>
                                    <!-- Clic droit pour menu contextuel -->
                                    <Border Background="{DynamicResource HoverBrush}"
                                            CornerRadius="3"
                                            Padding="4,2"
                                            Margin="0,0,4,0"
                                            ToolTip="Clic droit pour plus d'actions">
                                        <TextBlock Text="Clic droit"
                                                   FontSize="9"
                                                   Foreground="{DynamicResource TextTertiaryBrush}"/>
                                    </Border>
                                    <!-- Enter pour ouvrir -->
                                    <TextBlock Text="â†µ"
                                               FontSize="10"
                                               Foreground="{DynamicResource TextTertiaryBrush}"
                                               VerticalAlignment="Center"/>
                                </StackPanel>
                                
                                <!-- Raccourci Alt+N -->
                                <Border Grid.Column="4"
                                        Background="{DynamicResource HoverBrush}"
                                        CornerRadius="3"
                                        Padding="5,2"
                                        Margin="6,0,0,0"
                                        VerticalAlignment="Center"
                                        Visibility="{Binding (ItemsControl.AlternationIndex),
                                            RelativeSource={RelativeSource AncestorType=ListBoxItem},
                                            Converter={StaticResource AltShortcutVis}}">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsInfoBlock}" Value="True">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding DataContext.ShowShortcutHints, RelativeSource={RelativeSource AncestorType=Window}}" Value="False">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <TextBlock Text="{Binding (ItemsControl.AlternationIndex),
                                                   RelativeSource={RelativeSource AncestorType=ListBoxItem},
                                                   Converter={StaticResource AltShortcut}}"
                                               FontSize="9"
                                               FontFamily="Consolas"
                                               Foreground="{DynamicResource TextTertiaryBrush}"
                                               Opacity="0.7"/>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                
                <!-- Hint en bas quand pas de rÃ©sultats -->
                <TextBlock
                           Text="Tapez ':help' pour voir les commandes disponibles&#x0a;Utilisez ':find &lt;terme&gt;' pour rechercher dans tout le systÃ¨me"
                           Foreground="#555"
                           FontSize="11"
                           HorizontalAlignment="Center"
                           TextAlignment="Center"
                           Margin="0,20,0,20"
                           Visibility="{Binding HasResults, Converter={StaticResource InverseBoolToVis}}"/>
            </Grid>
            
            <!-- Barre de statut (pas de cache, rarement animÃ©e) -->
            <Border Grid.Row="2"
                    Background="{DynamicResource SurfaceAltBrush}"
                    CornerRadius="0,0,12,12"
                    Padding="12,6"
                    Visibility="{Binding HasResults, Converter={StaticResource BoolToVis}}">
                <Grid>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding Results.Count, StringFormat='{}{0} rÃ©sultat(s)'}"
                                   FontSize="10"
                                   Foreground="#666"/>
                        <TextBlock Text=" â€¢ "
                                   FontSize="10"
                                   Foreground="#444"/>
                        <TextBlock FontSize="10" Foreground="#666">
                            <Run Text="Enter"/>
                            <Run Text="Ouvrir" Foreground="#888"/>
                            <Run Text=" â”‚ "/>
                            <Run Text="Clic droit"/>
                            <Run Text="Actions" Foreground="#888"/>
                            <Run Text=" â”‚ "/>
                            <Run Text="Ctrl+Enter"/>
                            <Run Text="Admin" Foreground="#888"/>
                        </TextBlock>
                    </StackPanel>
                    
                    <!-- Indicateur d'indexation -->
                    <StackPanel Orientation="Horizontal"
                                HorizontalAlignment="Right"
                                Visibility="{Binding IsIndexing, Converter={StaticResource BoolToVis}}">
                        <TextBlock Text="â³"
                                   FontSize="10"
                                   Margin="0,0,4,0"/>
                        <TextBlock Text="Indexation..."
                                   FontSize="10"
                                   Foreground="#888"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
        </Border>
    </Grid>
</Window>
